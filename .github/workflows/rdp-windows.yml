name: RDP + GitHub Pages

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Install Tailscale
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
        Start-Process -Wait -FilePath "msiexec.exe" -ArgumentList "/i","$env:TEMP\tailscale.msi","/qn","/norestart"
        Start-Sleep -Seconds 10
        
    - name: Connect Tailscale
      shell: pwsh
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}"
        Start-Sleep -Seconds 15
        
        $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
        
    - name: Show RDP Info
      shell: pwsh
      run: |
        Write-Host "RDP disponible en: $env:TAILSCALE_IP"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "### ðŸ”— RDP Access"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Tailscale IP:** $env:TAILSCALE_IP"

  pages-deploy:
    runs-on: ubuntu-latest
    needs: rdp-setup
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Show Pages URL
      run: |
        echo "PÃ¡gina desplegada en: ${{ steps.deployment.outputs.page_url }}"
        echo "PAGES_URL=${{ steps.deployment.outputs.page_url }}" >> $env:GITHUB_ENV
