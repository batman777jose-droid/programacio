name: RDP + GitHub Pages

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Check system info
      shell: pwsh
      run: |
        Write-Host "ðŸ”§ InformaciÃ³n del Sistema"
        Write-Host "OS: $([Environment]::OSVersion)"
        Write-Host "Usuario: $env:USERNAME"
        Get-Date
        
    - name: Download and Install Tailscale
      shell: pwsh
      run: |
        Write-Host "ðŸ“¥ Descargando Tailscale..."
        try {
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
          Write-Host "âœ… Descarga completada"
        } catch {
          Write-Host "âŒ Error en descarga: $($_.Exception.Message)"
          exit 1
        }
        
        Write-Host "ðŸ”§ Instalando Tailscale..."
        try {
          $process = Start-Process -Wait -PassThru -FilePath "msiexec.exe" -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/qn", "/norestart"
          if ($process.ExitCode -ne 0) {
            Write-Host "âŒ Error en instalaciÃ³n. CÃ³digo: $($process.ExitCode)"
            exit 1
          }
          Write-Host "âœ… InstalaciÃ³n completada"
        } catch {
          Write-Host "âŒ Error instalando: $($_.Exception.Message)"
          exit 1
        }
        
        Start-Sleep -Seconds 10
        
        # Verificar instalaciÃ³n
        if (Test-Path "C:\Program Files\Tailscale\tailscale.exe") {
          Write-Host "âœ… Tailscale instalado correctamente"
          & "C:\Program Files\Tailscale\tailscale.exe" version
        } else {
          Write-Host "âŒ Tailscale no se encontrÃ³ despuÃ©s de instalaciÃ³n"
          exit 1
        }
        
    - name: Connect to Tailscale
      shell: pwsh
      run: |
        Write-Host "ðŸ”— Conectando a Tailscale..."
        
        # Limpiar conexiones anteriores
        Write-Host "ðŸ”„ Limpiando estado anterior..."
        & "C:\Program Files\Tailscale\tailscale.exe" logout 2>$null
        Start-Sleep -Seconds 5
        
        # Conectar con authkey
        Write-Host "ðŸ”‘ Autenticando con Tailscale..."
        $result = & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --accept-routes --accept-dns 2>&1
        Write-Host "Output de conexiÃ³n: $result"
        Write-Host "Exit Code: $LASTEXITCODE"
        
        # Esperar y verificar
        Write-Host "â³ Esperando establecimiento de conexiÃ³n..."
        Start-Sleep -Seconds 25
        
        # Verificar estado
        Write-Host "ðŸ“Š Verificando estado..."
        $status = & "C:\Program Files\Tailscale\tailscale.exe" status
        Write-Host "Status completo: $status"
        
        # Obtener IP
        $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
        Write-Host "IP obtenida: '$ip'"
        
        if ($ip -and $ip -ne "") {
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "âœ… ConexiÃ³n exitosa - IP: $ip"
        else {
          Write-Host "âŒ No se pudo obtener IP de Tailscale"
          Write-Host "Posibles causas:"
          Write-Host "1. AuthKey invÃ¡lida o revocada"
          Write-Host "2. Problemas de red en el runner"
          Write-Host "3. Restricciones en la cuenta Tailscale"
          exit 1
        }
        
    - name: Configure RDP
      shell: pwsh
      run: |
        Write-Host "ðŸ–¥ï¸ Configurando Remote Desktop..."
        
        # Habilitar RDP
        try {
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "âœ… RDP habilitado en registro y firewall"
        } catch {
          Write-Host "âš ï¸ Error configurando RDP: $($_.Exception.Message)"
        }
        
        # Configurar usuario
        Write-Host "ðŸ‘¤ Configurando usuario RDP..."
        try {
          $userExists = Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue
          if (-not $userExists) {
            Write-Host "Creando usuario runneradmin..."
            $securePassword = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
            New-LocalUser -Name "runneradmin" -Password $securePassword -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runneradmin"
            Write-Host "âœ… Usuario runneradmin creado"
          } else {
            Write-Host "âœ… Usuario runneradmin ya existe"
          }
        } catch {
          Write-Host "âš ï¸ Error configurando usuario: $($_.Exception.Message)"
        }
        
    - name: Show Connection Information
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "ðŸŽ‰ ===== CONFIGURACIÃ“N COMPLETADA ====="
        Write-Host "ðŸ–¥ï¸  RDP disponible en: $env:TAILSCALE_IP"
        Write-Host "ðŸ‘¤  Usuario: runneradmin"
        Write-Host "ðŸ”‘  ContraseÃ±a: [Configurada en secrets]"
        Write-Host "ðŸ”§  Puerto: 3389"
        Write-Host ""
        Write-Host "ðŸ“‹ Para conectarte:"
        Write-Host "1. Abre ConexiÃ³n a Escritorio Remoto"
        Write-Host "2. Ingresa la IP: $env:TAILSCALE_IP"
        Write-Host "3. Usuario: runneradmin"
        Write-Host "4. ContraseÃ±a del secret RDP_PASSWORD"
        Write-Host ""
        
        # Agregar al summary del workflow
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "# ðŸ–¥ï¸ RDP Access Ready"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## ðŸ”— InformaciÃ³n de ConexiÃ³n"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **IP:** $env:TAILSCALE_IP"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **Usuario:** runneradmin"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **Puerto:** 3389"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **ContraseÃ±a:** Usa el secret RDP_PASSWORD"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## ðŸ“ Instrucciones"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "1. Abre **ConexiÃ³n a Escritorio Remoto**"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "2. Conectate a: **$env:TAILSCALE_IP**"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "3. Usuario: **runneradmin**"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "4. ContraseÃ±a: **La del secret RDP_PASSWORD**"

  pages-deploy:
    runs-on: ubuntu-latest
    needs: rdp-setup
    if: always()  # Se ejecuta incluso si RDP falla
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Show Pages URL
      run: |
        echo "ðŸŒ PÃ¡gina desplegada en: ${{ steps.deployment.outputs.page_url }}"
        echo "PAGES_URL=${{ steps.deployment.outputs.page_url }}" >> $env:GITHUB_ENV
