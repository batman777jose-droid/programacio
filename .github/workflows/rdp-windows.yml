name: RDP Windows VM

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  create-rdp-vm:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Configure RDP
      run: |
        # Habilitar Escritorio Remoto
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        
        # Configurar firewall
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        
        # Reiniciar servicio
        Restart-Service -Name TermService -Force

    - name: Create User
      run: |
        # Crear usuario con contrase√±a segura
        $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | % {[char]$_})
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "github" -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "github"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "github"
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    - name: Install Tailscale
      run: |
        # Descargar e instalar Tailscale
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
        Start-Process -Wait -PassThru -FilePath "msiexec.exe" -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/qn", "/norestart"
        Start-Sleep -Seconds 10

    - name: Connect Tailscale
      run: |
        # Conectar a Tailscale
        Start-Process -Wait -PassThru -FilePath "C:\Program Files\Tailscale\tailscale.exe" -ArgumentList "up", "--authkey=${{ secrets.TAILSCALE_AUTHKEY }}"
        Start-Sleep -Seconds 15
        
        # Obtener IP de Tailscale
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        if (-not $ip) {
            Write-Error "No se pudo obtener la IP de Tailscale"
            exit 1
        }
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
        
        # Agregar al summary
        echo "### üéâ RDP VM Lista" >> $env:GITHUB_STEP_SUMMARY
        echo "**Direcci√≥n RDP:** $ip" >> $env:GITHUB_STEP_SUMMARY
        echo "**Usuario:** github" >> $env:GITHUB_STEP_SUMMARY
        echo "**Contrase√±a:** $env:RDP_PASSWORD" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "‚è∞ Esta VM estar√° activa por 6 horas" >> $env:GITHUB_STEP_SUMMARY

    - name: Show Connection Info
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "üéâ M√ÅQUINA VIRTUAL LISTA"
        Write-Host "=========================================="
        Write-Host "RDP Address: $env:TAILSCALE_IP"
        Write-Host "Username: github"
        Write-Host "Password: $env:RDP_PASSWORD"
        Write-Host "=========================================="
        Write-Host "‚è∞ Esta VM estar√° activa por 6 horas"
        Write-Host "=========================================="
        Write-Host ""

    - name: Keep VM Alive
      run: |
        # Mantener la VM activa por 355 minutos (5 minutos menos del timeout)
        $endTime = (Get-Date).AddMinutes(355)
        while ((Get-Date) -lt $endTime) {
            $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
            Write-Host "[$(Get-Date)] VM activa - Tiempo restante: $remaining minutos"
            Start-Sleep -Seconds 60
        }
        Write-Host "‚è∞ Tiempo agotado - La VM se apagar√° pronto"
