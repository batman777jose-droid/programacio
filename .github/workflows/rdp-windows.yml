name: RDP Windows VM

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  create-rdp-vm:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        Restart-Service -Name TermService -Force

    - name: Create User
      run: |
        $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | % {[char]$_})
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "github" -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "github"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "github"
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    - name: Install Tailscale
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
        Start-Process -Wait -FilePath "msiexec.exe" -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/qn", "/norestart"

    - name: Connect Tailscale
      run: |
        Start-Process -Wait -FilePath "C:\Program Files\Tailscale\tailscale.exe" -ArgumentList "up", "--authkey=${{ secrets.TAILSCALE_AUTHKEY }}"
        Start-Sleep -Seconds 10
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
        echo "RDP Connection: $ip" >> $env:GITHUB_STEP_SUMMARY

    - name: Show Connection Info
      run: |
        Write-Host "=========================================="
        Write-Host "ðŸŽ‰ RDP VM READY - Connect via Tailscale"
        Write-Host "=========================================="
        Write-Host "RDP Address: $env:TAILSCALE_IP"
        Write-Host "Username: github" 
        Write-Host "Password: $env:RDP_PASSWORD"
        Write-Host "=========================================="

    - name: Keep VM Alive
      run: |
        $endTime = (Get-Date).AddMinutes(355)
        while ((Get-Date) -lt $endTime) {
            Write-Host "[$(Get-Date)] VM active - Time remaining: $([math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)) minutes"
            Start-Sleep -Seconds 60
        }
