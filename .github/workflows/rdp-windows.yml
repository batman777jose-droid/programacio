name: RDP + GitHub Pages

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Download and Install Tailscale
      shell: pwsh
      run: |
        Write-Host "ðŸ“¥ Descargando Tailscale..."
        
        # Intentar con diferentes URLs
        $urls = @(
          "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi",
          "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi", 
          "https://tailscale.com/download/windows"
        )
        
        $success = $false
        foreach ($url in $urls) {
          try {
            Write-Host "Intentando descargar desde: $url"
            Invoke-WebRequest -Uri $url -OutFile "$env:TEMP\tailscale.msi" -TimeoutSec 30
            Write-Host "âœ… Descarga exitosa desde: $url"
            $success = $true
            break
          } catch {
            Write-Host "âŒ FallÃ³ $url : $($_.Exception.Message)"
          }
        }
        
        if (-not $success) {
          Write-Host "ðŸš¨ Todas las URLs fallaron. Intentando mÃ©todo alternativo..."
          # MÃ©todo alternativo usando winget
          winget install --id Tailscale.Tailscale --silent --accept-package-agreements --accept-source-agreements
          Start-Sleep -Seconds 15
        } else {
          Write-Host "ðŸ”§ Instalando Tailscale..."
          $process = Start-Process -Wait -PassThru -FilePath "msiexec.exe" -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/qn", "/norestart"
          if ($process.ExitCode -ne 0) {
            Write-Host "âš ï¸ InstalaciÃ³n MSI fallÃ³. Probando winget..."
            winget install --id Tailscale.Tailscale --silent --accept-package-agreements --accept-source-agreements
          }
          Write-Host "âœ… InstalaciÃ³n completada"
        }
        
        Start-Sleep -Seconds 10
        
        # Verificar instalaciÃ³n
        $tailscalePaths = @(
          "C:\Program Files\Tailscale\tailscale.exe",
          "$env:ProgramFiles\Tailscale\tailscale.exe",
          "${env:ProgramFiles(x86)}\Tailscale\tailscale.exe"
        )
        
        $tailscaleExe = $null
        foreach ($path in $tailscalePaths) {
          if (Test-Path $path) {
            $tailscaleExe = $path
            Write-Host "âœ… Tailscale encontrado en: $path"
            break
          }
        }
        
        if (-not $tailscaleExe) {
          Write-Host "âŒ Tailscale no se encontrÃ³ despuÃ©s de instalaciÃ³n"
          Write-Host "Instalando via mÃ©todo directo..."
          # Ãšltimo intento con descarga directa
          $webClient = New-Object System.Net.WebClient
          $webClient.DownloadFile("https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi", "$env:TEMP\tailscale-final.msi")
          Start-Process -Wait -FilePath "msiexec.exe" -ArgumentList "/i", "$env:TEMP\tailscale-final.msi", "/qn", "/norestart"
          Start-Sleep -Seconds 10
        }
        
    - name: Connect to Tailscale
      shell: pwsh
      run: |
        Write-Host "ðŸ”— Conectando a Tailscale..."
        
        # Encontrar tailscale.exe
        $tailscaleExe = "C:\Program Files\Tailscale\tailscale.exe"
        if (-not (Test-Path $tailscaleExe)) {
          $tailscaleExe = "${env:ProgramFiles(x86)}\Tailscale\tailscale.exe"
        }
        
        if (-not (Test-Path $tailscaleExe)) {
          Write-Host "âŒ No se pudo encontrar tailscale.exe"
          exit 1
        }
        
        Write-Host "Tailscale ejecutable: $tailscaleExe"
        
        # Limpiar conexiones anteriores
        Write-Host "ðŸ”„ Limpiando estado anterior..."
        & $tailscaleExe logout 2>$null
        Start-Sleep -Seconds 5
        
        # Conectar con authkey
        Write-Host "ðŸ”‘ Autenticando con Tailscale..."
        $authKey = "${{ secrets.TAILSCALE_AUTHKEY }}"
        if (-not $authKey -or $authKey -eq "") {
          Write-Host "âŒ TAILSCALE_AUTHKEY no estÃ¡ configurado"
          exit 1
        }
        
        Write-Host "Longitud de authkey: $($authKey.Length)"
        $result = & $tailscaleExe up --authkey="$authKey" --accept-routes --accept-dns 2>&1
        Write-Host "Output de conexiÃ³n: $result"
        Write-Host "Exit Code: $LASTEXITCODE"
        
        # Esperar y verificar
        Write-Host "â³ Esperando establecimiento de conexiÃ³n..."
        Start-Sleep -Seconds 25
        
        # Verificar estado
        Write-Host "ðŸ“Š Verificando estado..."
        $status = & $tailscaleExe status
        Write-Host "Status: $status"
        
        # Obtener IP
        $ip = (& $tailscaleExe ip -4).Trim()
        Write-Host "IP obtenida: '$ip'"
        
        if ($ip -and $ip -ne "") {
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "âœ… ConexiÃ³n exitosa - IP: $ip"
        else {
          Write-Host "âŒ No se pudo obtener IP de Tailscale"
          Write-Host "Probando con mÃ¡s tiempo..."
          Start-Sleep -Seconds 30
          $ip = (& $tailscaleExe ip -4).Trim()
          if ($ip) {
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
            Write-Host "âœ… ConexiÃ³n exitosa despuÃ©s de espera - IP: $ip"
          } else {
            exit 1
          }
        }
        
    - name: Configure RDP
      shell: pwsh
      run: |
        Write-Host "ðŸ–¥ï¸ Configurando Remote Desktop..."
        
        # Habilitar RDP
        try {
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "âœ… RDP habilitado en registro y firewall"
        } catch {
          Write-Host "âš ï¸ Error configurando RDP: $($_.Exception.Message)"
        }
        
        # Configurar usuario
        Write-Host "ðŸ‘¤ Configurando usuario RDP..."
        try {
          $userExists = Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue
          if (-not $userExists) {
            Write-Host "Creando usuario runneradmin..."
            $securePassword = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
            New-LocalUser -Name "runneradmin" -Password $securePassword -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runneradmin"
            Write-Host "âœ… Usuario runneradmin creado"
          } else {
            Write-Host "âœ… Usuario runneradmin ya existe"
          }
        } catch {
          Write-Host "âš ï¸ Error configurando usuario: $($_.Exception.Message)"
        }
        
    - name: Show Connection Information
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "ðŸŽ‰ ===== CONFIGURACIÃ“N COMPLETADA ====="
        Write-Host "ðŸ–¥ï¸  RDP disponible en: $env:TAILSCALE_IP"
        Write-Host "ðŸ‘¤  Usuario: runneradmin"
        Write-Host "ðŸ”‘  ContraseÃ±a: [Configurada en secrets]"
        Write-Host "ðŸ”§  Puerto: 3389"
        Write-Host ""
        Write-Host "ðŸ“‹ Para conectarte:"
        Write-Host "1. Abre ConexiÃ³n a Escritorio Remoto"
        Write-Host "2. Ingresa la IP: $env:TAILSCALE_IP"
        Write-Host "3. Usuario: runneradmin"
        Write-Host "4. ContraseÃ±a del secret RDP_PASSWORD"
        Write-Host ""
        
        # Agregar al summary del workflow
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "# ðŸ–¥ï¸ RDP Access Ready"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## ðŸ”— InformaciÃ³n de ConexiÃ³n"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **IP:** $env:TAILSCALE_IP"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **Usuario:** runneradmin"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **Puerto:** 3389"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- **ContraseÃ±a:** Usa el secret RDP_PASSWORD"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## ðŸ“ Instrucciones"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "1. Abre **ConexiÃ³n a Escritorio Remoto**"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "2. Conectate a: **$env:TAILSCALE_IP**"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "3. Usuario: **runneradmin**"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "4. ContraseÃ±a: **La del secret RDP_PASSWORD**"

  pages-deploy:
    runs-on: ubuntu-latest
    needs: rdp-setup
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Show Pages URL
      run: |
        echo "ðŸŒ PÃ¡gina desplegada en: ${{ steps.deployment.outputs.page_url }}"
        echo "PAGES_URL=${{ steps.deployment.outputs.page_url }}" >> $env:GITHUB_ENV
