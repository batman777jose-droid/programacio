name: RDP + GitHub Pages

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Download Tailscale
      shell: pwsh
      run: |
        Write-Host "ğŸ“¥ Descargando Tailscale..."
        try {
          # URL directa y funcional
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
          Invoke-WebRequest -Uri $url -OutFile "$env:TEMP\tailscale.msi"
          Write-Host "âœ… Descarga completada"
        } catch {
          Write-Host "âŒ Error en descarga, intentando mÃ©todo alternativo..."
          # MÃ©todo alternativo
          $url = "https://tailscale.com/download/windows"
          Invoke-WebRequest -Uri $url -OutFile "$env:TEMP\tailscale.msi"
        }
        
    - name: Install Tailscale
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Instalando Tailscale..."
        Start-Process -Wait -FilePath "msiexec.exe" -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/qn", "/norestart"
        Start-Sleep -Seconds 15
        Write-Host "âœ… Tailscale instalado"

    - name: Connect Tailscale
      shell: pwsh
      run: |
        Write-Host "ğŸ”— Conectando a Tailscale..."
        
        # Esperar a que el servicio estÃ© listo
        Start-Sleep -Seconds 10
        
        # Conectar con authkey
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --accept-routes --accept-dns
        Write-Host "âœ… Comando de conexiÃ³n ejecutado"
        
        # Esperar conexiÃ³n
        Start-Sleep -Seconds 20
        
        # Obtener IP
        $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
        Write-Host "ğŸ¯ IP de Tailscale: $ip"

    - name: Configure Windows RDP
      shell: pwsh
      run: |
        Write-Host "ğŸ–¥ï¸ Configurando RDP..."
        
        # Habilitar RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        
        # Configurar firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Crear usuario para RDP
        $securePassword = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
        New-LocalUser -Name "runneradmin" -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runneradmin"
        
        Write-Host "âœ… RDP configurado - Usuario: runneradmin"

    - name: Show RDP Connection Info
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ === RDP LISTO ==="
        Write-Host "ğŸ“ IP: $env:TAILSCALE_IP"
        Write-Host "ğŸ‘¤ Usuario: runneradmin"
        Write-Host "ğŸ” ContraseÃ±a: ******"
        Write-Host "ğŸ”§ Puerto: 3389"
        Write-Host ""
        
        # Agregar al resumen del workflow
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "# ğŸ–¥ï¸ RDP Configurado"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**IP:** $env:TAILSCALE_IP"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Usuario:** runneradmin"
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**ContraseÃ±a:** [Del secret RDP_PASSWORD]"

  pages-deploy:
    runs-on: ubuntu-latest
    needs: rdp-setup
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Show Pages URL
      run: |
        echo "ğŸŒ PÃ¡gina desplegada: ${{ steps.deployment.outputs.page_url }}"
